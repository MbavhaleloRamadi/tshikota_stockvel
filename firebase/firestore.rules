rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if the request is from an admin session
    // Note: In production, you'd want to use custom claims for admin verification
    function isAdmin() {
      return isAuthenticated();
    }
    
    // Settings collection - contains admin code and app configuration
    match /settings/{document} {
      // Anyone can read settings (needed for login verification)
      allow read: if true;
      // Only authenticated users can create initial settings
      allow create: if isAuthenticated();
      // Only authenticated users can update (admin code changes)
      allow update: if isAuthenticated();
      // Never allow delete
      allow delete: if false;
    }
    
    // Members collection - stores member information
    match /members/{memberId} {
      // Anyone can read members (needed for member lookup)
      allow read: if true;
      // Only authenticated users can create/update members
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      // Never allow delete - members are permanent records
      allow delete: if false;
    }
    
    // Submissions collection - stores payment submissions
    match /submissions/{submissionId} {
      // Anyone can read submissions (members need to see their own)
      allow read: if true;
      // Anyone can create submissions (for POP upload)
      allow create: if true;
      // Only authenticated users can update (for approval/rejection)
      allow update: if isAuthenticated();
      // Never allow delete - financial records are immutable
      allow delete: if false;
    }
    
    // Interest Pool collection - tracks fines and interest by year
    match /interestPool/{year} {
      // Anyone can read interest pool data
      allow read: if true;
      // Only authenticated users can create/update
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      // Never allow delete
      allow delete: if false;
    }
    
    // Audit Logs collection - tracks all admin actions
    match /auditLogs/{logId} {
      // Only authenticated users can read audit logs
      allow read: if isAuthenticated();
      // Only authenticated users can create logs
      allow create: if isAuthenticated();
      // Never allow update or delete - audit logs are immutable
      allow update: if false;
      allow delete: if false;
    }
    
    // Monthly Summaries collection - aggregated monthly data
    match /monthlySummaries/{summaryId} {
      // Anyone can read summaries
      allow read: if true;
      // Only authenticated users can create/update
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      // Never allow delete
      allow delete: if false;
    }
    
    // Payouts collection - year-end distribution records
    match /payouts/{payoutId} {
      // Anyone can read payouts
      allow read: if true;
      // Only authenticated users can create
      allow create: if isAuthenticated();
      // Never allow update or delete - payout records are immutable
      allow update: if false;
      allow delete: if false;
    }
    
    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
